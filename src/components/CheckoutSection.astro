---
// CheckoutSection.astro
const ebooks = [
    {
        id: 1,
        title: "SUPLEMENTOS",
        price: "29.99",
        image: "/images/ebook1.webp",
        description:
            "Descubre los secretos de la nutrición deportiva con esta guía completa. Aprende a optimizar tu alimentación para maximizar tus resultados en el gimnasio y mejorar tu composición corporal.",
    },
    {
        id: 2,
        title: "BIENESTAR INTEGRAL",
        price: "39.99",
        image: "/images/ebook2.webp",
        description:
            "Rutinas profesionales diseñadas para llevarte al siguiente nivel. Incluye programas de fuerza, hipertrofia y definición muscular con técnicas avanzadas de entrenamiento.",
    },
    {
        id: 3,
        title: "RECETAS SALUDABLES",
        price: "24.99",
        image: "/images/ebook3.webp",
        description:
            "Más de 50 recetas deliciosas y saludables para alcanzar tus objetivos. Comidas balanceadas, fáciles de preparar y perfectas para tu estilo de vida fitness.",
    },
];

const { productId } = Astro.props;
// Also try to get from URL params if not passed as prop (for direct page access)
const urlProductId = Astro.url.searchParams.get("productId");
const idToUse = productId || urlProductId;

const selectedEbook = ebooks.find((e) => e.id == idToUse) || ebooks[0]; // Default to first if not found
---

<section
    class="relative w-full bg-black pt-32 pb-24 px-6 sm:px-10 lg:px-16 overflow-hidden min-h-screen flex items-center justify-center"
>
    <!-- Background Decor -->
    <div
        class="absolute top-0 right-0 w-[800px] h-[800px] bg-[#aba070]/5 blur-[150px] rounded-full translate-x-1/2 -translate-y-1/2 pointer-events-none"
    >
    </div>
    <div
        class="absolute bottom-0 left-0 w-[800px] h-[800px] bg-orange-500/5 blur-[150px] rounded-full -translate-x-1/2 translate-y-1/2 pointer-events-none"
    >
    </div>

    <div class="max-w-7xl mx-auto w-full relative z-10">
        <div
            class="grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-24 items-start"
        >
            <!-- Left Column: Payment -->
            <div class="space-y-10 order-2 lg:order-1">
                <div class="space-y-4">
                    <h2
                        class="text-[#aba070] font-black tracking-[0.4em] text-xs uppercase italic"
                    >
                        PASARELA SEGURA
                    </h2>
                    <h3
                        class="text-4xl md:text-6xl font-black text-white tracking-tighter uppercase italic"
                    >
                        MÉTODO DE PAGO
                    </h3>
                </div>

                <div
                    class="p-10 md:p-14 rounded-[3rem] bg-white/5 backdrop-blur-3xl border border-white/10 shadow-3xl"
                >
                    <div
                        id="paypal-button-container"
                        class="min-h-[150px] flex items-center justify-center"
                    >
                        <div
                            class="w-8 h-8 border-2 border-[#aba070] border-t-transparent rounded-full animate-spin"
                        >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="space-y-10 order-1 lg:order-2">
                <div class="space-y-4">
                    <h2
                        class="text-[#aba070] font-black tracking-[0.4em] text-xs uppercase italic"
                    >
                        TU SELECCIÓN
                    </h2>
                    <h3
                        class="text-4xl md:text-6xl font-black text-white tracking-tighter uppercase italic"
                    >
                        RESUMEN
                    </h3>
                </div>

                <div
                    class="group relative p-8 md:p-12 rounded-[3.5rem] bg-white/5 backdrop-blur-3xl border border-white/10 shadow-3xl overflow-hidden"
                >
                    <div class="flex flex-col md:flex-row gap-10 items-center">
                        <div
                            class="w-full md:w-40 aspect-[3/4] rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative"
                        >
                            <img
                                src={selectedEbook.image}
                                alt={selectedEbook.title}
                                class="w-full h-full object-cover brightness-90 group-hover:brightness-100 transition-all duration-700"
                                loading="eager"
                            />
                            <div
                                class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"
                            >
                            </div>
                        </div>

                        <div
                            class="flex-grow space-y-6 text-center md:text-left"
                        >
                            <h3
                                class="text-3xl font-black text-white tracking-wide uppercase italic"
                            >
                                {selectedEbook.title}
                            </h3>
                            <p
                                class="text-gray-400 font-light leading-relaxed text-sm"
                            >
                                {selectedEbook.description}
                            </p>

                            <div
                                class="pt-8 border-t border-white/10 flex flex-col md:flex-row justify-between items-center gap-4"
                            >
                                <span
                                    class="text-gray-500 font-black text-[10px] tracking-[0.3em] uppercase"
                                    >TOTAL A INVERTIR</span
                                >
                                <span
                                    class="text-5xl font-black text-white tracking-tighter italic"
                                >
                                    <span
                                        class="text-[#aba070] text-3xl font-bold mr-1"
                                        >$</span
                                    >{selectedEbook.price}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style></style>

<script define:vars={{ selectedEbook }}>
    const CLIENT_ID =
        "AdiDzE-xMnufghuTrnoUNXWATuyAWh-T_GrZ9BQajojAEgtWg53cugm04twlrIkgfwSoBwfYyj8q1Inz";

    const loadPayPalScript = () => {
        if (window.paypal) return Promise.resolve();
        return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = `https://www.paypal.com/sdk/js?client-id=${CLIENT_ID}&currency=USD`;
            script.async = true;
            script.onload = () => resolve();
            script.onerror = (err) => reject(err);
            document.head.appendChild(script);
        });
    };

    const renderButton = () => {
        if (!window.paypal) return;
        const container = document.getElementById("paypal-button-container");
        if (!container) return;
        container.innerHTML = "";
        window.paypal
            .Buttons({
                style: {
                    layout: "vertical",
                    color: "gold",
                    shape: "rect",
                    label: "pay",
                },
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [
                            {
                                description: selectedEbook.title,
                                amount: { value: selectedEbook.price },
                            },
                        ],
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then((details) => {
                        alert(
                            `¡PAGO EXITOSO! BIENVENIDO AL EQUIPO, ${details.payer.name.given_name.toUpperCase()}`,
                        );
                        window.location.href = "/";
                    });
                },
                onError: (err) => {
                    console.error("PayPal Error:", err);
                    alert("HUBO UN ERROR AL PROCESAR EL PAGO.");
                },
            })
            .render("#paypal-button-container");
    };

    loadPayPalScript()
        .then(renderButton)
        .catch((err) => console.error("PayPal Init Failed:", err));
</script>
